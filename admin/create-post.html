<!DOCTYPE HTML>
<html>
	<head>
		<title>Barnwell - Create Post</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="../assets/css/main.css" />
		<noscript><link rel="stylesheet" href="../assets/css/noscript.css" /></noscript>
		<style>
			@import url('https://fonts.bunny.net/css2?family=Cinzel:wght@400..900&display=swap');
			
			#header {
				padding: 1rem 0 0 0 !important;
			}
			
			#header .content .inner h1 {
				font-family: 'Cinzel', serif;
				font-weight: 600;
				font-size: 3.5rem;
			}
			
			#header:before,
			#header:after,
			#header > *:before,
			#header > *:after,
			#header nav:before,
			#header nav:after,
			#wrapper:before,
			#wrapper:after {
				display: none !important;
				border: none !important;
				content: none !important;
				background: none !important;
				width: 0 !important;
				height: 0 !important;
			}
			
			/* Background image */
			#bg:after {
				background-image: url("../images/background.png") !important;
				background-position: center !important;
				background-size: cover !important;
				background-repeat: no-repeat !important;
			}

			/* Post creation form styles */
			#main {
				display: block !important;
				opacity: 1 !important;
				visibility: visible !important;
				position: relative !important;
				z-index: 1;
			}

			#main article {
				opacity: 1 !important;
				visibility: visible !important;
				display: block !important;
				position: relative !important;
				z-index: 1;
			}

			.post-container {
				max-width: 800px;
				margin: 2rem auto;
				padding: 2rem;
				background: rgba(27, 31, 34, 0.85);
				border: 1px solid rgba(255, 255, 255, 0.1);
				border-radius: 8px;
				opacity: 1 !important;
				visibility: visible !important;
				position: relative !important;
				z-index: 2;
			}

			.post-form {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
			}

			.form-group {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}

			.form-group label {
				color: rgba(255, 255, 255, 0.8);
				font-size: 0.9rem;
				font-family: 'Cinzel', serif;
			}

			.form-group input,
			.form-group textarea,
			.form-group select {
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 4px;
				padding: 0.7rem 1rem;
				color: white;
				font-family: inherit;
				width: 100%;
				box-sizing: border-box;
			}

			.form-group textarea {
				min-height: 200px;
				resize: vertical;
			}

			.form-group input:focus,
			.form-group textarea:focus,
			.form-group select:focus {
				outline: none;
				border-color: rgba(255, 255, 255, 0.4);
			}

			.submit-button {
				background: rgba(255, 255, 255, 0.2);
				color: white;
				border: 1px solid rgba(255, 255, 255, 0.3);
				padding: 0.0rem 0.0rem 2.0rem;
				border-radius: 4px;
				cursor: pointer;
				font-family: 'Cinzel', serif;
				font-size: 1rem;
				transition: background 0.2s;
				width: 100%;
			}

			.submit-button:hover {
				background: rgba(255, 255, 255, 0.3);
			}

			.error-message,
			.success-message {
				padding: 1rem;
				border-radius: 4px;
				margin-top: 1rem;
				text-align: center;
				display: none;
			}

			.error-message {
				background: rgba(255, 99, 71, 0.2);
				border: 1px solid rgba(255, 99, 71, 0.3);
				color: #ff6b6b;
			}

			.success-message {
				background: rgba(144, 238, 144, 0.2);
				border: 1px solid rgba(144, 238, 144, 0.3);
				color: #90ee90;
			}

			.back-link {
				display: block;
				text-align: center;
				margin-top: 2rem;
				color: rgba(255, 255, 255, 0.7);
				text-decoration: none;
				font-family: 'Cinzel', serif;
				transition: color 0.2s;
			}

			.back-link:hover {
				color: white;
			}

			@media screen and (max-width: 480px) {
				.post-container {
					margin: 1rem;
					padding: 1.5rem;
				}
			}
		</style>
	</head>
	<body class="is-preload">
		<div id="wrapper">
			<header id="header">
				<div class="content">
					<div class="inner">
						<h1>Create Blog Post</h1>
					</div>
				</div>
			</header>

			<div id="main">
				<article>
					<div class="post-container">
						<form class="post-form" id="postForm">
							<div class="form-group">
								<label for="title">Title</label>
								<input type="text" id="title" name="title" required>
							</div>
							<div class="form-group">
								<label for="slug">Slug (URL-friendly name)</label>
								<input type="text" id="slug" name="slug" required>
							</div>
							<div class="form-group">
								<label for="excerpt">Excerpt (Brief summary)</label>
								<textarea id="excerpt" name="excerpt" rows="3"></textarea>
							</div>
							<div class="form-group">
								<label for="content">Content</label>
								<textarea id="content" name="content" required></textarea>
							</div>
							<div class="form-group">
								<label for="image_url">Image URL (Optional)</label>
								<input type="url" id="image_url" name="image_url">
							</div>
							<div class="form-group">
								<label for="category_id">Category</label>
								<select id="category_id" name="category_id" required>
									<option value="">Select a category</option>
								</select>
							</div>
							<div class="form-group">
								<label for="author">Author Name</label>
								<input type="text" id="author" name="author" required>
							</div>
							<button type="submit" class="submit-button">Create Post</button>
							<div class="error-message" id="errorMessage"></div>
							<div class="success-message" id="successMessage"></div>
						</form>
						<a href="../" class="back-link">&larr; Back to Home</a>
					</div>
				</article>
			</div>

			<footer id="footer">
				<p class="copyright">&copy; Barnwell</p>
				<p class="copyright">Website by <a href="https://admtech.org">ADM Technology</a></p>
			</footer>
		</div>

		<div id="bg"></div>

		<!-- Scripts -->
		<script src="../assets/js/jquery.min.js"></script>
		<script src="../assets/js/browser.min.js"></script>
		<script src="../assets/js/breakpoints.min.js"></script>
		<script src="../assets/js/util.js"></script>
		<script src="../assets/js/main.js"></script>
		<script>
			// Check authentication on page load
			document.addEventListener('DOMContentLoaded', function() {
				const token = localStorage.getItem('authToken');
				if (!token) {
					window.location.href = '../login';
					return;
				}

				const postForm = document.getElementById('postForm');
				const errorMessage = document.getElementById('errorMessage');
				const successMessage = document.getElementById('successMessage');
				const titleInput = document.getElementById('title');
				const slugInput = document.getElementById('slug');
				const API_URL = 'https://barnwell-blog-worker.admtech.us/api';

				// Auto-generate slug from title
				titleInput.addEventListener('input', function() {
					slugInput.value = this.value
						.toLowerCase()
						.replace(/[^a-z0-9]+/g, '-')
						.replace(/(^-|-$)/g, '');
				});

				// Handle form submission
				postForm.addEventListener('submit', async function(e) {
					e.preventDefault();
					
					errorMessage.style.display = 'none';
					successMessage.style.display = 'none';
					
					const formData = {
						title: document.getElementById('title').value,
						slug: document.getElementById('slug').value,
						excerpt: document.getElementById('excerpt').value,
						content: document.getElementById('content').value,
						image_url: document.getElementById('image_url').value || null,
						category_id: parseInt(document.getElementById('category_id').value),
						author: document.getElementById('author').value
					};
					
					try {
						const response = await fetch(`${API_URL}/blog?action=create_post`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Authorization': `Bearer ${token}`
							},
							body: JSON.stringify(formData)
						});
						
						const data = await response.json();
						
						if (response.ok && data.success) {
							successMessage.textContent = 'Post created successfully!';
							successMessage.style.display = 'block';
							postForm.reset();
						} else {
							errorMessage.textContent = data.error || 'Failed to create post';
							errorMessage.style.display = 'block';
						}
					} catch (error) {
						console.error('Error creating post:', error);
						errorMessage.textContent = 'An error occurred. Please try again later.';
						errorMessage.style.display = 'block';
					}
				});

				// Load categories
				async function loadCategories() {
					try {
						const response = await fetch(`${API_URL}/blog?action=get_categories`, {
							headers: {
								'Authorization': `Bearer ${token}`
							}
						});
						
						const data = await response.json();
						
						if (response.ok && data.success) {
							const categorySelect = document.getElementById('category_id');
							
							// Clear existing options except the first one
							while (categorySelect.options.length > 1) {
								categorySelect.remove(1);
							}
							
							data.data.forEach(category => {
								const option = document.createElement('option');
								option.value = category.id;
								option.textContent = category.name;
								categorySelect.appendChild(option);
							});
						} else {
							throw new Error(data.error || 'Failed to load categories');
						}
					} catch (error) {
						console.error('Error loading categories:', error);
						errorMessage.textContent = 'Failed to load categories: ' + error.message;
						errorMessage.style.display = 'block';
					}
				}

				// Initial load of categories
				loadCategories();
			});
		</script>
	</body>
</html> 